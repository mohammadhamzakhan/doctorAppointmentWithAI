generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "postgresql"
  relationMode = "prisma"
}

model Admin {
  id                Int       @id @default(autoincrement())
  email             String    @unique
  password          String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  isActive          Boolean   @default(true)
  loginAtempts      Int       @default(0)
  lastLogin         DateTime?
  hashToken         String?
  name              String?   @default("Admin")
  emailChangeExpiry DateTime?
  emailChangeCode   String?
  passwordResetCode String?
  isEmailVerifeid   Boolean   @default(false)
}

model Doctor {
  id                    Int                  @id @default(autoincrement())
  name                  String
  email                 String               @unique
  password              String
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  isActive              Boolean              @default(true)
  loginAtempts          Int                  @default(0)
  lastLogin             DateTime?
  hashToken             String?
  specialization        String
  emailChangeExpiry     DateTime?
  emailChangeCode       String?
  passwordResetCode     String?
  bio                   String?
  clinicName            String?
  isAutoBooking         Boolean              @default(true)
  isEmailVerified       Boolean              @default(false)
  isProfileCompleted    Boolean              @default(false)
  lockedUntil           DateTime?
  phoneNumber           String?
  slotDuration          Int                  @default(15)
  bookingDisabledUntil  DateTime?
  bookingMode           BookingMode          @default(QUEUE)
  dailyBufferMinutes    Int                  @default(0)
  gracePeriodMinutes    Int                  @default(10)
  isBookingEnabled      Boolean              @default(true)
  maxAppointmentsPerDay Int                  @default(32)
  scheduleLockedUntil   DateTime?
  timezone              String               @default("Asia/Karachi")
  phoneNumberId         String?              @unique
  waAccessToken         String?              @db.Text
  assistants            assistant[]
  appointments          Appointment[]
  doctorAvailabilities  DoctorAvailability[]
  messageLogs           MessageLog[]
}

model DoctorAvailability {
  id        Int      @id @default(autoincrement())
  doctorId  Int
  day       Int
  startTime String
  endTime   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  doctor    Doctor   @relation(fields: [doctorId], references: [id])

  @@index([doctorId])
}

model assistant {
  id           Int           @id @default(autoincrement())
  doctorId     Int
  name         String        @unique
  password     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  isActive     Boolean       @default(true)
  loginAtempts Int           @default(0)
  lastLogin    DateTime?
  hashToken    String?
  Doctor       Doctor        @relation(fields: [doctorId], references: [id])
  appointments Appointment[]

  @@index([doctorId])
}

model Patient {
  id           Int           @id @default(autoincrement())
  name         String
  phone        String        @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  appointments Appointment[]
  messageLogs  MessageLog[]
}

model Appointment {
  id                Int               @id @default(autoincrement())
  doctorId          Int
  assistantId       Int?
  patientId         Int
  appointmentDate   DateTime
  reason            String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  appointmentStatus AppointmentStatus @default(pending)
  actualDuration    Int?
  actualEnd         DateTime?
  actualStart       DateTime?
  bookedBy          BookingSource
  cancelledAt       DateTime?
  expectedDuration  Int
  isDeleted         Boolean           @default(false)
  isNoShow          Boolean           @default(false)
  lockedUntil       DateTime?
  queueNumber       Int
  scheduledEnd      DateTime
  scheduledStart    DateTime
  Doctor            Doctor            @relation(fields: [doctorId], references: [id])
  Assistant         assistant?        @relation(fields: [assistantId], references: [id])
  Patient           Patient           @relation(fields: [patientId], references: [id])

  @@unique([doctorId, scheduledStart])
  @@index([doctorId])
  @@index([assistantId])
  @@index([patientId])
  @@index([appointmentDate])
  @@index([queueNumber])
}

model MessageLog {
  id        Int      @id @default(autoincrement())
  doctorId  Int
  patientId Int
  message   String
  direction String
  createdAt DateTime @default(now())
  doctor    Doctor   @relation(fields: [doctorId], references: [id])
  patient   Patient  @relation(fields: [patientId], references: [id])

  @@index([doctorId])
  @@index([patientId])
}

enum BookingMode {
  FIXED
  QUEUE
}

enum BookingSource {
  ai
  doctor
  assistant
  patient
}

enum AppointmentStatus {
  pending
  confirmed
  cancelled
  completed
  rescheduled
}
